<!-- Darts scoreboard layout -->
<div class="row">
  <div id="game-over-banner" class="col-12 mb-4" style="display: none;">
    <div class="alert alert-success text-center py-3">
      <h2 class="mb-0" style="font-size: 36px; font-weight: bold;">GAME OVER!</h2>
    </div>
  </div>
  <!-- Left side: Turns and scores table -->
  <div class="col-md-8">
    <div class="table-responsive">
      <table class="table table-bordered" id="scoreTable">
        <thead>
          <tr>
            <th class="text-center turn-header">TURN #</th>
            {% for player in game_data.players %}
            <th class="text-center player-header" id="player{{ player.id }}_name">{{ player.name }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody id="turns_body">
          <!-- This section will be managed by JavaScript -->
        </tbody>
        <tfoot>
          <tr>
            <td class="text-center"><strong>TOTAL</strong></td>
            {% for player in game_data.players %}
            <td class="text-center" id="player{{ player.id }}_total">{{ player.total_score }}</td>
            {% endfor %}
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  
  <!-- Right side: Dartboard and current throws -->
  <div class="col-md-4 text-center">
    <div class="dartboard-container mb-4">
      <img src="{{ url_for('static', filename='images/dartboard.jpg') }}" 
        alt="Dartboard" class="img-fluid" style="max-height: 400px;">
    </div>
    
    <div class="row mt-4">
      {% for throw in game_data.current_throws %}
      <div class="col-4">
        <div class="card">
          <div class="card-header p-2">
            <strong>THROW {{ throw.throw_number }}<br>POINTS</strong>
          </div>
          <div class="card-body" id="throw{{ throw.throw_number }}_points">
            {{ throw.points }}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  // Function to update the display with new data
  function updateGame(game_data) {
    // Check if game is over and update banner
    const gameOverBanner = document.getElementById('game-over-banner');
    if (game_data.game_over) {
      gameOverBanner.style.display = 'block';
      
      // Find player with score 0 (the winner)
      const winner = game_data.players.find(player => player.total_score === 0);
      if (winner) {
        // Highlight the winner's name and score in the table
        const nameElement = document.getElementById(`player${winner.id}_name`);
        const totalElement = document.getElementById(`player${winner.id}_total`);
        
        if (nameElement) {
          nameElement.style.backgroundColor = 'rgba(40, 167, 69, 0.7)';
          nameElement.style.color = 'white';
          nameElement.style.fontWeight = 'bold';
        }
        
        if (totalElement) {
          totalElement.style.backgroundColor = 'rgba(40, 167, 69, 0.7)';
          totalElement.style.color = 'white';
          totalElement.style.fontWeight = 'bold';
        }
      }
    } else {
      gameOverBanner.style.display = 'none';
    }
    
    // Update player names and totals
    for (let i = 0; i < game_data.players.length; i++) {
      const player = game_data.players[i];
      const nameElement = document.getElementById(`player${player.id}_name`);
      const totalElement = document.getElementById(`player${player.id}_total`);
      
      if (nameElement) nameElement.textContent = player.name;
      if (totalElement) totalElement.textContent = player.total_score;
    }
    
    // Determine which turns to display (last 10 turns)
    const maxTurnsToShow = 10;
    let turnsToDisplay = game_data.turns;
    
    if (game_data.turns.length > maxTurnsToShow) {
      // Show only the last 10 turns
      turnsToDisplay = game_data.turns.slice(-maxTurnsToShow);
    }
    
    // Rebuild the turns table
    const tbody = document.getElementById('turns_body');
    let tableHTML = '';
    
    // Add rows for the turns to display
    for (const turn of turnsToDisplay) {
      tableHTML += `<tr><td class="text-center">${turn.turn_number}</td>`;
      
      for (const player of game_data.players) {
        tableHTML += `<td class="text-center" id="turn_${turn.turn_number}_player_${player.id}">`;
        
        // Find score for this player
        const score = turn.scores.find(s => s.player_id === player.id);
        if (score) {
          tableHTML += score.points;
        }
        
        tableHTML += `</td>`;
      }
      
      tableHTML += `</tr>`;
    }
    
    // Add empty rows if we have fewer than 10 turns
    if (turnsToDisplay.length < maxTurnsToShow) {
      const nextTurnNumber = game_data.turns.length > 0 
        ? Math.max(...game_data.turns.map(t => t.turn_number)) + 1 
        : 1;
      
      for (let i = 0; i < maxTurnsToShow - turnsToDisplay.length; i++) {
        const turnNumber = nextTurnNumber + i;
        
        tableHTML += `<tr><td class="text-center">${turnNumber}</td>`;
        
        for (const player of game_data.players) {
          tableHTML += `<td class="text-center" id="turn_${turnNumber}_player_${player.id}"></td>`;
        }
        
        tableHTML += `</tr>`;
      }
    }
    
    // Update the table
    tbody.innerHTML = tableHTML;
    
    // Update current throws
    for (let i = 0; i < game_data.current_throws.length; i++) {
      const throwData = game_data.current_throws[i];
      const throwElement = document.getElementById(`throw${throwData.throw_number}_points`);
      
      if (throwElement && throwElement.textContent !== throwData.points.toString()) {
        blinkUpdate(throwElement, throwData.points.toString());
      }
    }
  }

  function blinkUpdate(element, newValue, newColor='#00ff00') {
    previousColor = element.style.color;
    element.textContent = newValue;
    element.style.color = newColor;
    
    // Set back to original color after timeout ms
    setTimeout(() => {
      element.style.color = previousColor;
    }, 2000);
  }
  
  // Set up polling for updates
  setInterval(function() {
    fetch('/data_json')
      .then(response => response.json())
      .then(data => updateGame(data))
      .catch(error => console.error('Error fetching data:', error));
  }, 1000);
</script>

<style>
  .turn-header, .player-header {
    background-color: #e9ecef;
    color: #212529;
  }
  
  .card-header {
    background-color: #6c757d;
    color: white;
  }
  
  .card-body {
    font-size: 24px;
    font-weight: bold;
    color: #000000;
  }
  
  #scoreTable tbody td {
  font-size: 24px;
  font-weight: bold;
  text-align: center;
  vertical-align: middle;
  color: #ffffff;
  }
  


  /*
  
  Alternating row colors 
  #scoreTable tbody tr:nth-child(odd) {
    background-color: rgba(0, 0, 100, 0.7);
  }
  
  #scoreTable tbody tr:nth-child(even) {
    background-color: rgba(0, 0, 70, 0.7);
  }
  
  Highlight the current active turn 
  #scoreTable tbody tr.active-turn {
    background-color: rgba(0, 100, 100, 0.5);
  }
  
  Add hover effect for better UX 
  #scoreTable tbody tr:hover {
    background-color: rgba(50, 50, 150, 0.8);
  }
  */
  /*Make the totals row stand out */
  #scoreTable tfoot tr {
  font-size: 24px;
  font-weight: bold;
  text-align: center;
  vertical-align: middle;
  color: #ffffff;
  }
  

</style>
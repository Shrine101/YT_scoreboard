<script>
    // Helper function to get mark symbol
    function getMarkSymbol(marks) {
      if (marks === 0) return '';
      if (marks === 1) return '/';
      if (marks === 2) return 'X';
      if (marks === 3) return 'XXX';
      return '';
    }
    
    // Function to update cricket scoreboard
    function updateCricketScoreboard(game_data) {
      // First fetch the cricket scores from the database
      fetch('/get_cricket_scores')
        .then(response => response.json())
        .then(cricketData => {
          // For each player and number, update the table cell
          for (const player of game_data.players) {
            // Update total score first
            const totalElement = document.getElementById(`player${player.id}_total`);
            if (totalElement) {
              totalElement.textContent = player.total_score;
            }
            
            // Update each number's mark for this player
            const numbers = [15, 16, 17, 18, 19, 20, 25]; // 25 is bullseye
            for (const number of numbers) {
              const cellId = `player${player.id}_number_${number}`;
              const cell = document.getElementById(cellId);
              
              if (cell) {
                // Get this player's data for this number
                const playerData = cricketData[player.id];
                if (playerData && playerData.numbers[number]) {
                  const numberData = playerData.numbers[number];
                  const marks = numberData.marks || 0;
                  const closed = numberData.closed || false;
                  
                  // Create the content for the cell
                  if (closed) {
                    cell.innerHTML = `<span class="cricket-closed">XXX</span>`;
                    cell.classList.add('number-closed');
                  } else {
                    cell.textContent = getMarkSymbol(marks);
                    cell.classList.remove('number-closed');
                  }
                } else {
                  cell.textContent = '';
                }
              }
            }
          }
          
          // Highlight current player
          for (const player of game_data.players) {
            const nameElement = document.getElementById(`player${player.id}_name`);
            if (nameElement) {
              if (player.id === game_data.current_player) {
                nameElement.classList.add('active-player');
              } else {
                nameElement.classList.remove('active-player');
              }
            }
          }
        })
        .catch(error => {
          console.error('Error fetching cricket scores:', error);
        });
    }
  
    // Function to update throws
    function updateNormalThrows(game_data) {
      // Update all throws
      for (let i = 0; i < game_data.current_throws.length; i++) {
        const throwData = game_data.current_throws[i];
        const throwElement = document.getElementById(`throw${throwData.throw_number}_points`);
        
        // Only blink update if value has changed
        if (throwElement && throwElement.textContent !== throwData.points.toString()) {
          // Use a different color for zero values vs non-zero
          const blinkColor = throwData.points > 0 ? '#00ff00' : '#333333';
          blinkUpdate(throwElement, throwData.points.toString(), blinkColor);
        }
      }
    }
    
    // Function to show a cricket notification
    function showCricketNotification(type, duration = 3000) {
      const cricketBanner = document.getElementById('cricket-banner');
      const numberClosedOverlay = document.getElementById('number-closed-overlay');
      
      if (type === 'closed') {
        if (cricketBanner) cricketBanner.style.visibility = 'visible';
        if (numberClosedOverlay) numberClosedOverlay.style.visibility = 'visible';
      }
      
      // Hide the banner after the duration
      setTimeout(() => {
        if (cricketBanner) cricketBanner.style.visibility = 'hidden';
        if (numberClosedOverlay) numberClosedOverlay.style.visibility = 'hidden';
      }, duration);
    }
  
    // Handle Manual Override response for American Cricket mode
    window.handleManualOverrideResponse = function(data, manualOverrideModal) {
      manualOverrideModal.hide();
      
      // Refresh the game data regardless
      fetch('/data_json')
        .then(response => response.json())
        .then(gameData => updateGame(gameData))
        .catch(error => console.error('Error fetching data:', error));
        
      // Alert with throw information
      alert(`Throw updated successfully! Score: ${data.score}, Points: ${data.points}`);
    };
    
    // Function to update the game with new data
    function updateGame(game_data) {
      // Apply styling based on player count
      updatePlayerCountStyle(game_data);
      
      // Store current game data globally for delayed updates
      window.currentGameData = game_data;
      
      // Update the last throw display
      updateLastThrow(game_data.last_throw, game_data.players, game_data);
      
      // Check if game is over and update banner
      if (game_data.game_over) {
        // For Cricket, check animation state for the winner
        if (game_data.animating && game_data.animation_type === 'win') {
          const winner = game_data.players.find(player => player.id === game_data.current_player);
          if (winner) {
            // Set the winner's name in both banners
            document.getElementById('winner-name').textContent = winner.name;
            document.getElementById('winner-name-overlay').textContent = winner.name;
            
            // Show the overlay
            document.getElementById('win-message-overlay').style.visibility = 'visible';
            
            // Highlight the winner's name and score in the table
            const nameElement = document.getElementById(`player${winner.id}_name`);
            const totalElement = document.getElementById(`player${winner.id}_total`);
            
            if (nameElement) {
              nameElement.style.backgroundColor = 'rgba(40, 167, 69, 0.7)';
              nameElement.style.color = 'white';
              nameElement.style.fontWeight = 'bold';
            }
            
            if (totalElement) {
              totalElement.style.backgroundColor = 'rgba(40, 167, 69, 0.7)';
              totalElement.style.color = 'white';
              totalElement.style.fontWeight = 'bold';
            }
          }
        }
      } else {
        document.getElementById('win-message-overlay').style.visibility = 'hidden';
      }
      
      // Handle animation based on type
      if (game_data.animating) {
        if (game_data.animation_type === 'cricket_closed') {
          // Show number closed notification
          showCricketNotification('closed');
          
          // Update cricket scoreboard
          updateCricketScoreboard(game_data);
          updateNormalThrows(game_data);
        } else if (game_data.animation_type === 'cricket_marks' || game_data.animation_type === 'cricket_points') {
          // Update normally for marks or points
          updateCricketScoreboard(game_data);
          updateNormalThrows(game_data);
        } else if (game_data.animation_type === 'third_throw') {
          // For third throw animations, update normally
          updateCricketScoreboard(game_data);
          updateNormalThrows(game_data);
        } else if (game_data.animation_type === 'win') {
          // Show game over banner for win animations
          const winner = game_data.players.find(player => player.id === game_data.current_player);
          if (winner) {
            // Update both winner displays
            document.getElementById('winner-name').textContent = winner.name;
            document.getElementById('winner-name-overlay').textContent = winner.name;
            document.getElementById('win-message-overlay').style.visibility = 'visible';
          }
          
          // Find the winning throw
          const throwNumber = game_data.throw_number;
          const throwElement = document.getElementById(`throw${throwNumber}_points`);
          
          if (throwElement) {
            // Check if we already started this animation
            if (!window.animatingWin) {
              window.animatingWin = true;
              
              // Set the throw to a gold color to indicate it's the winning throw
              const winThrow = game_data.current_throws.find(t => t.throw_number === parseInt(throwNumber));
              if (winThrow) {
                throwElement.textContent = winThrow.points.toString();
                throwElement.style.color = '#ffd700'; // Gold color
              }
              
              // Update the cricket scoreboard
              updateCricketScoreboard(game_data);
              
              // Reset animation flag after a delay
              setTimeout(() => {
                window.animatingWin = false;
              }, 3000);
            }
          }
        }
      } else {
        // Standard non-animation updates
        document.getElementById('cricket-banner').style.visibility = 'hidden';
        document.getElementById('number-closed-overlay').style.visibility = 'hidden';
        
        // If we're not in an animation, update everything normally
        if (!window.animatingWin) {
          updateCricketScoreboard(game_data);
          updateNormalThrows(game_data);
        }
      }
    }
  
    // Add style for cricket marks
    document.addEventListener('DOMContentLoaded', function() {
      // Add style for cricket closed numbers
      const style = document.createElement('style');
      style.textContent = `
        .cricket-closed {
          color: #28a745;
          font-weight: bold;
        }
        .number-closed {
          background-color: rgba(40, 167, 69, 0.2);
        }
      `;
      document.head.appendChild(style);
    });
  
    // Initialize the table with empty marks
    document.addEventListener('DOMContentLoaded', function() {
      // Initially clear all cells
      const cells = document.querySelectorAll('td[id^="player"][id$="25"]');
      cells.forEach(cell => {
        cell.textContent = '';
      });
      
      // Start polling for updates
      updateGame(window.currentGameData || {});
    });
  </script>